@page "/order/add"
@inject HttpClient http
@inject NavigationManager navigationManager
@inject NotificationService notificationService

<PageTitle>Add Order</PageTitle>

<div class="form-group mb-3">
    <h3 class="text-center">Add Order</h3>
</div>

<EditForm Model="@order" OnValidSubmit="OnValidSubmit">
    <DataAnnotationsValidator />
    <div class="form-group">
        <label for="name">Name</label>
        <div>
            <InputText class="form-control" id="name" @bind-Value="order.Name" />
            <ValidationMessage For="(() => order.Name)"></ValidationMessage>
        </div>
    </div>
    <div class="form-group">
        <label for="state">State</label>
        <div>
            <InputText class="form-control" id="state" @bind-Value="order.State" />
            <ValidationMessage For="(() => order.State)"></ValidationMessage>
        </div>
    </div>

    <div class="form-group">
        <div class="form-group mt-3 mb-3">
            <button type="button" class="btn btn-secondary"
                    @onclick="@(() => order.Windows?.Add(new Window()))">
                Add Window
            </button>
        </div>

        @for (var i = 0; i < order.Windows?.Count; i++)
        {
            var index = i;
            var window = order.Windows[i];

            <h5>Window @(i+1)</h5>

            <form class="form-inline" role="form">
                <div class="form-group">
                    <label for="@i">Name:</label>
                    <InputText class="form-control" id="@i" @bind-Value="window.Name" />
                </div>

                <div class="form-group">
                    <label for="">Quantity Of Windows:</label>
                    <InputNumber class="form-control" @bind-Value="window.QuantityOfWindows" />
                </div>
                <div class="form-group">
                    <label for="">Total Sub Elements:</label>
                    <InputNumber class="form-control" @bind-Value="window.TotalSubElements" />
                </div>

                <div class="form-group mt-3 mb-3">
                    <button type="button" class="btn btn-danger"
                        @onclick="@(() => order.Windows.RemoveAt(index))">
                        Remove
                    </button>
                </div>
            </form>
        }
    </div>

    <div class="form-group mt-3">
        <button class="btn btn-primary" type="submit">Save</button>
        <button class="btn btn-secondary" type="button" @onclick="clear">Clear</button>
    </div>

</EditForm>

@code {

    private Order order = new Order();

    protected async Task OnValidSubmit()
    {
        var response = await http.PostAsJsonAsync("orders", order);
        var body = await response.Content.ReadAsStringAsync();

        if (response.IsSuccessStatusCode)
        {
            notificationService.Notify(new NotificationMessage() { Severity = NotificationSeverity.Success, Summary = "Success", Detail = "Order has been saved successfully." });
            navigationManager.NavigateTo("orders");
        }
        else
        {
            notificationService.Notify(new NotificationMessage() { Severity = NotificationSeverity.Error, Summary = "Error", Detail = "Failed to save order." });
        }
    }

    private void clear()
    {
        order = new Order();
    }

}
